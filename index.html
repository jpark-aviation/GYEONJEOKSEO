<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ê²¬ì ì„œ ìƒì„± í”„ë¡œê·¸ë¨</title>
    <!-- html2pdf.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Malgun Gothic', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #f5f5f5; 
            padding: 10px; 
            line-height: 1.6;
            -webkit-text-size-adjust: 100%;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            padding: 20px; 
        }
        h1 { 
            text-align: center; 
            color: #333; 
            margin-bottom: 30px; 
            font-size: clamp(20px, 4vw, 28px); 
        }
        .section { 
            margin-bottom: 25px; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: #fafafa; 
        }
        .section-title { 
            font-size: clamp(16px, 3vw, 18px); 
            font-weight: bold; 
            margin-bottom: 15px; 
            color: #444; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 5px; 
        }
        .form-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            margin-bottom: 15px; 
            align-items: center; 
        }
        .form-group { 
            display: flex; 
            flex-direction: column; 
            min-width: 200px; 
            flex: 1; 
        }
        .form-group.inline { 
            flex-direction: row; 
            align-items: center; 
            gap: 10px; 
        }
        label { 
            font-weight: bold; 
            color: #555; 
            margin-bottom: 5px; 
            font-size: 14px; 
        }
        .form-group.inline label { 
            margin-bottom: 0; 
            min-width: 80px; 
        }
        
        /* í•„ìˆ˜ í•­ëª© ë³„í‘œ ìŠ¤íƒ€ì¼ */
        .required {
            color: #dc3545;
            font-weight: bold;
            margin-left: 3px;
        }
        
        input, textarea, select { 
            padding: 12px 15px; 
            border: 2px solid #ccc; 
            border-radius: 6px; 
            font-size: 16px; 
            width: 100%; 
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* ë‚ ì§œ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        #date {
            cursor: pointer;
            background-color: #fff;
            position: relative;
        }
        
        #date:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0,123,255,0.3);
        }
        
        /* ë‹¬ë ¥ ì•„ì´ì½˜ ì¶”ê°€ */
        .date-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .date-input-wrapper::after {
            content: "ğŸ“…";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 16px;
        }
        
        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: #007bff; 
            box-shadow: 0 0 8px rgba(0,123,255,0.3); 
            transform: scale(1.02);
        }
        
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 15px 25px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 8px; 
            transition: all 0.3s ease; 
            min-width: 140px;
            min-height: 48px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        button:hover, button:focus { 
            background: #0056b3; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0,123,255,0.3);
        }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        button.warning { background: #ffc107; color: #212529; }
        button.warning:hover { background: #e0a800; }
        
        .table-container { 
            overflow-x: auto; 
            margin-top: 15px; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
            -webkit-overflow-scrolling: touch;
        }
        .items-table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 700px; 
        }
        .items-table th, .items-table td { 
            border: 1px solid #ddd; 
            padding: 12px 10px; 
            text-align: center; 
            font-size: 14px; 
        }
        .items-table th { 
            background: #f8f9fa; 
            font-weight: bold; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        .items-table tr:nth-child(even) { background: #f9f9f9; }
        .items-table tr:hover { background: #e9ecef; }
        
        .total-section { 
            text-align: right; 
            margin-top: 20px; 
            font-size: clamp(16px, 3vw, 18px); 
            font-weight: bold; 
            color: #007bff; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 5px; 
        }
        
        /* ë¶€ê°€ì„¸ ê³„ì‚° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .calculation-section {
            text-align: right;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 2px solid #007bff;
        }
        
        .calculation-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .calculation-row.subtotal {
            font-weight: bold;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }
        
        .calculation-row.vat {
            color: #666;
        }
        
        .calculation-row.total {
            font-weight: bold;
            font-size: 18px;
            color: #007bff;
            border-top: 2px solid #007bff;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .notes-area { 
            width: 100%; 
            min-height: 120px; 
            resize: vertical; 
            font-family: inherit; 
            font-size: 16px; /* ê¸°íƒ€ì‚¬í•­ í°íŠ¸ í¬ê¸° ì¦ê°€ */
        }
        .button-group { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px; 
            margin-top: 30px; 
        }
        .readonly-info { 
            background: #e9ecef; 
            padding: 15px; 
            border-radius: 4px; 
            color: #6c757d; 
            font-size: 14px; 
            line-height: 1.5; 
        }
        
        /* PDF ì „ìš© ìŠ¤íƒ€ì¼ */
        .pdf-content { 
            font-family: 'Malgun Gothic', Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 40px 20px; 
            background: white; 
            line-height: 1.6; 
            display: none;
        }
        .pdf-title { 
            text-align: center; 
            font-size: 24px; 
            font-weight: bold; 
            margin-bottom: 40px; 
            border-bottom: 3px solid #333; 
            padding-bottom: 15px; 
        }
        
        /* PDF ì •ë³´ ì„¹ì…˜ - í…Œì´ë¸” ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½ */
        .pdf-info-section { 
            width: 100%;
            margin-bottom: 30px;
        }
        
        .pdf-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        
        .pdf-info-table td {
            padding: 8px 0;
            vertical-align: top;
            font-size: 14px;
        }
        
        .pdf-info-table .left-column {
            width: 50%;
            padding-right: 20px;
        }
        
        .pdf-info-table .right-column {
            width: 50%;
            text-align: right;
            padding-left: 20px;
        }
        
        .pdf-info-item { 
            margin-bottom: 8px; 
            font-size: 14px; 
        }
        .pdf-info-label { 
            font-weight: bold; 
            display: inline-block; 
            width: 80px; 
        }
        .pdf-section-title { 
            font-size: 16px; 
            font-weight: bold; 
            margin: 30px 0 15px 0; 
            padding: 8px 0; 
            border-bottom: 2px solid #666; 
        }
        .pdf-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0; 
            font-size: 12px; 
        }
        .pdf-table th { 
            background-color: #f0f0f0; 
            border: 1px solid #333; 
            padding: 10px 5px; 
            text-align: center; 
            font-weight: bold; 
        }
        .pdf-table td { 
            border: 1px solid #333; 
            padding: 8px 5px; 
            text-align: center; 
        }
        .pdf-table .text-left { text-align: left; }
        .pdf-table .text-right { text-align: right; }
        .pdf-table .text-center { text-align: center; }
        .pdf-table .pdf-total-row { background-color: #f8f8f8; font-weight: bold; }
        
        /* PDF ë¶€ê°€ì„¸ ê³„ì‚° í…Œì´ë¸” */
        .pdf-calculation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
        }
        
        .pdf-calculation-table td {
            border: 1px solid #333;
            padding: 8px 5px;
            text-align: right;
        }
        
        .pdf-calculation-table .label-cell {
            text-align: center;
            font-weight: bold;
            background-color: #f0f0f0;
        }
        
        .pdf-calculation-table .total-row {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        
        .pdf-notes { 
            margin-top: 30px; 
            padding: 15px; 
            background-color: #f9f9f9; 
            border-left: 4px solid #007bff; 
        }
        .pdf-notes-title { font-weight: bold; margin-bottom: 10px; }
        .pdf-notes-content { font-size: 13px; line-height: 1.5; } /* ê¸°íƒ€ì‚¬í•­ í°íŠ¸ í¬ê¸° ì¦ê°€ */
        .pdf-footer { 
            margin-top: 40px; 
            text-align: center; 
            font-size: 12px; 
            color: #666; 
        }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 15px; border-radius: 5px; }
            .section { padding: 12px; margin-bottom: 15px; }
            .form-row { flex-direction: column; gap: 12px; }
            .form-group { min-width: 100%; }
            .form-group.inline { flex-direction: column; align-items: flex-start; }
            .form-group.inline label { min-width: auto; margin-bottom: 5px; }
            .button-group { flex-direction: column; align-items: stretch; }
            button { 
                margin: 6px 0; 
                padding: 18px; 
                font-size: 18px; 
                min-height: 52px;
            }
            .items-table th, .items-table td { padding: 10px 6px; font-size: 13px; }
            .readonly-info { font-size: 13px; padding: 12px; }
            .total-section, .calculation-section { text-align: center; padding: 12px; }
            
            /* ëª¨ë°”ì¼ í„°ì¹˜ ê°œì„  */
            input, textarea { font-size: 16px; padding: 14px; }
            .items-table button { padding: 10px 15px; min-width: 70px; }
            
            .calculation-row {
                font-size: 14px;
            }
            
            .calculation-row.total {
                font-size: 16px;
            }
            
            /* PDF ì •ë³´ í…Œì´ë¸” ëª¨ë°”ì¼ ìµœì í™” */
            .pdf-info-table .left-column,
            .pdf-info-table .right-column {
                width: 100%;
                padding: 0;
                text-align: left;
            }
        }
        
        /* íƒœë¸”ë¦¿ ìµœì í™” */
        @media (min-width: 769px) and (max-width: 1024px) {
            .form-row { gap: 12px; }
            .form-group { min-width: 180px; }
            button { padding: 14px 22px; }
        }
        
        /* ë¯¸ë¦¬ë³´ê¸° ì°½ */
        .preview-window { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 90%; 
            height: 80%; 
            max-width: 800px; 
            background: white; 
            border: 2px solid #007bff; 
            border-radius: 10px; 
            z-index: 1000; 
            overflow: auto; 
            padding: 20px; 
            display: none; 
        }
        .preview-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 999; 
            display: none; 
        }
        .close-btn { 
            position: absolute; 
            top: 10px; 
            right: 15px; 
            background: #dc3545; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 35px; 
            height: 35px; 
            cursor: pointer; 
            font-size: 18px; 
        }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ê²¬ì ì„œ ìƒì„± í”„ë¡œê·¸ë¨</h1>
        
        <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
        <div class="section">
            <div class="section-title">ê¸°ë³¸ ì •ë³´</div>
            <div class="form-row">
                <div class="form-group inline">
                    <label>ì¼ì‹œ:</label>
                    <div class="date-input-wrapper">
                        <input type="date" id="date" value="">
                    </div>
                </div>
                <div class="form-group inline">
                    <label>ë°›ëŠ”ë¶„:</label>
                    <input type="text" id="clientName" placeholder="ê³ ê°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group inline">
                    <label>ì „í™”:</label>
                    <input type="tel" id="clientPhone" placeholder="ê³ ê° ì „í™”ë²ˆí˜¸">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group inline">
                    <label>ì‹œê³µë‚´ì—­:</label>
                    <input type="text" id="workDetails" placeholder="ì‹œê³µë‚´ì—­ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
            </div>
            <div class="readonly-info">
                <strong>ì‹œê³µì:</strong> ì¢‹ì€ì´ì›ƒ ì¸í…Œë¦¬ì–´<br>
                <strong>ì „í™”:</strong> 010-6687-5111<br>
                <strong>ì£¼ì†Œ:</strong> ê²½ê¸°ë„ í™”ì„±ì‹œ í•œì‹ ëŒ€ê¸¸ 83
            </div>
        </div>

        <!-- í’ˆëª© ì…ë ¥ ì„¹ì…˜ -->
        <div class="section">
            <div class="section-title">í’ˆëª© ì…ë ¥</div>
            <div class="form-row">
                <div class="form-group">
                    <label>í’ˆëª©:</label>
                    <input type="text" id="itemCategory" placeholder="í’ˆëª©">
                </div>
                <div class="form-group">
                    <label>í’ˆëª…<span class="required">*</span>:</label>
                    <input type="text" id="itemName" placeholder="í’ˆëª… (í•„ìˆ˜)">
                </div>
                <div class="form-group">
                    <label>ê·œê²©:</label>
                    <input type="text" id="itemSpec" placeholder="ê·œê²©">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ìˆ˜ëŸ‰<span class="required">*</span>:</label>
                    <input type="number" id="itemQuantity" placeholder="ìˆ˜ëŸ‰ (í•„ìˆ˜)" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label>ë‹¨ìœ„:</label>
                    <input type="text" id="itemUnit" placeholder="ë‹¨ìœ„">
                </div>
                <div class="form-group">
                    <label>ë‹¨ê°€<span class="required">*</span>:</label>
                    <input type="number" id="itemPrice" placeholder="ë‹¨ê°€ (í•„ìˆ˜)" inputmode="numeric">
                </div>
            </div>
            <div class="button-group">
                <button id="addItemBtn" type="button">í’ˆëª© ì¶”ê°€</button>
            </div>
        </div>

        <!-- í’ˆëª© ëª©ë¡ ì„¹ì…˜ -->
        <div class="section">
            <div class="section-title">ê²¬ì  í’ˆëª© ëª©ë¡</div>
            <div class="table-container">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>í’ˆëª©</th>
                            <th>í’ˆëª…</th>
                            <th>ê·œê²©</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ë‹¨ìœ„</th>
                            <th>ë‹¨ê°€</th>
                            <th>ê³µê¸‰ê°€ì•¡</th>
                            <th>ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody"></tbody>
                </table>
            </div>
            
            <!-- ë¶€ê°€ì„¸ ê³„ì‚° ì„¹ì…˜ -->
            <div class="calculation-section">
                <div class="calculation-row subtotal">
                    <span>ì†Œê³„:</span>
                    <span id="subtotalAmount">0ì›</span>
                </div>
                <div class="calculation-row vat">
                    <span>ë¶€ê°€ì„¸ / VAT (10%):</span>
                    <span id="vatAmount">0ì›</span>
                </div>
                <div class="calculation-row total">
                    <span>í•©ê³„ (ë¶€ê°€ì„¸ í¬í•¨):</span>
                    <span id="totalAmount">0ì›</span>
                </div>
            </div>
        </div>

        <!-- ê¸°íƒ€ì‚¬í•­ ì„¹ì…˜ -->
        <div class="section">
            <div class="section-title">ê¸°íƒ€ì‚¬í•­</div>
            <div class="form-group">
                <textarea id="notes" class="notes-area" placeholder="ê¸°íƒ€ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>
        </div>

        <!-- ë²„íŠ¼ ê·¸ë£¹ -->
        <div class="button-group">
            <button id="previewBtn">ê²¬ì ì„œ ë¯¸ë¦¬ë³´ê¸°</button>
            <button id="printBtn" class="success">ì¸ì‡„í•˜ê¸°</button>
            <button id="downloadBtn" class="warning">PDFë¡œ ì €ì¥</button>
            <button id="clearBtn" class="danger">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- PDF ìƒì„±ìš© ìˆ¨ê²¨ì§„ ì½˜í…ì¸  -->
    <div id="pdfContent" class="pdf-content">
        <div class="pdf-title">ê²¬ ì  ì„œ</div>
        
        <!-- í…Œì´ë¸” ê¸°ë°˜ ì •ë³´ ì„¹ì…˜ìœ¼ë¡œ ë³€ê²½ -->
        <table class="pdf-info-table">
            <tr>
                <td class="left-column">
                    <div class="pdf-info-item"><span class="pdf-info-label">ì¼ì‹œ:</span> <span id="pdfDate"></span></div>
                    <div class="pdf-info-item"><span class="pdf-info-label">ë°›ëŠ”ë¶„:</span> <span id="pdfClientName"></span></div>
                    <div class="pdf-info-item"><span class="pdf-info-label">ì „í™”:</span> <span id="pdfClientPhone"></span></div>
                    <div class="pdf-info-item"><span class="pdf-info-label">ì‹œê³µë‚´ì—­:</span> <span id="pdfWorkDetails"></span></div>
                </td>
                <td class="right-column">
                    <div class="pdf-info-item"><span class="pdf-info-label">ì‹œê³µì:</span> ì¢‹ì€ì´ì›ƒ ì¸í…Œë¦¬ì–´</div>
                    <div class="pdf-info-item"><span class="pdf-info-label">ì „í™”:</span> 010-6687-5111</div>
                    <div class="pdf-info-item"><span class="pdf-info-label">ì£¼ì†Œ:</span> ê²½ê¸°ë„ í™”ì„±ì‹œ í•œì‹ ëŒ€ê¸¸ 83</div>
                </td>
            </tr>
        </table>
        
        <div class="pdf-section-title">ì„¸ë¶€ì‹œê³µë‚´ì—­</div>
        <table class="pdf-table" id="pdfTable">
            <thead>
                <tr>
                    <th style="width: 12%">í’ˆëª©</th>
                    <th style="width: 20%">í’ˆëª…</th>
                    <th style="width: 18%">ê·œê²©</th>
                    <th style="width: 8%">ìˆ˜ëŸ‰</th>
                    <th style="width: 8%">ë‹¨ìœ„</th>
                    <th style="width: 15%">ë‹¨ê°€</th>
                    <th style="width: 19%">ê³µê¸‰ê°€ì•¡</th>
                </tr>
            </thead>
            <tbody id="pdfTableBody"></tbody>
        </table>
        
        <!-- PDF ë¶€ê°€ì„¸ ê³„ì‚° í…Œì´ë¸” -->
        <table class="pdf-calculation-table">
            <tr>
                <td class="label-cell" style="width: 70%">ì†Œê³„</td>
                <td class="text-right" style="width: 30%"><span id="pdfSubtotal">0</span></td>
            </tr>
            <tr>
                <td class="label-cell">ë¶€ê°€ì„¸ / VAT (10%)</td>
                <td class="text-right"><span id="pdfVat">0</span></td>
            </tr>
            <tr class="total-row">
                <td class="label-cell"><strong>í•©ê³„ (ë¶€ê°€ì„¸ í¬í•¨)</strong></td>
                <td class="text-right"><strong id="pdfTotal">0</strong></td>
            </tr>
        </table>
        
        <div style="margin-top: 20px; font-size: 14px;">
            <strong>*ê³„ì•½ê¸ˆ ë³„ë„</strong>
        </div>
        <div class="pdf-notes" id="pdfNotesSection" style="display: none;">
            <div class="pdf-notes-title">ê¸°íƒ€ì‚¬í•­</div>
            <div class="pdf-notes-content" id="pdfNotes"></div>
        </div>
        <div class="pdf-footer">
            ê²¬ì ì„œ ë°œí–‰ì¼: <span id="pdfIssueDate"></span>
        </div>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° ì°½ -->
    <div class="preview-overlay" id="previewOverlay"></div>
    <div class="preview-window" id="previewWindow">
        <button class="close-btn" id="closeBtn">Ã—</button>
        <div id="previewContent"></div>
    </div>

    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <div>PDF ìƒì„± ì¤‘...</div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let items = [];
        let itemIdCounter = 0;

        // DOM ìš”ì†Œ ì°¸ì¡°
        const elements = {
            date: document.getElementById('date'),
            clientName: document.getElementById('clientName'),
            clientPhone: document.getElementById('clientPhone'),
            workDetails: document.getElementById('workDetails'),
            itemCategory: document.getElementById('itemCategory'),
            itemName: document.getElementById('itemName'),
            itemSpec: document.getElementById('itemSpec'),
            itemQuantity: document.getElementById('itemQuantity'),
            itemUnit: document.getElementById('itemUnit'),
            itemPrice: document.getElementById('itemPrice'),
            itemsTableBody: document.getElementById('itemsTableBody'),
            subtotalAmount: document.getElementById('subtotalAmount'),
            vatAmount: document.getElementById('vatAmount'),
            totalAmount: document.getElementById('totalAmount'),
            notes: document.getElementById('notes'),
            addItemBtn: document.getElementById('addItemBtn'),
            previewBtn: document.getElementById('previewBtn'),
            printBtn: document.getElementById('printBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            clearBtn: document.getElementById('clearBtn'),
            previewOverlay: document.getElementById('previewOverlay'),
            previewWindow: document.getElementById('previewWindow'),
            previewContent: document.getElementById('previewContent'),
            closeBtn: document.getElementById('closeBtn'),
            loadingSpinner: document.getElementById('loadingSpinner'),
            pdfContent: document.getElementById('pdfContent')
        };

        // ì´ˆê¸°í™” í•¨ìˆ˜
        function init() {
            setTodayDate();
            setupEventListeners();
        }

        // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì • (YYYY-MM-DD í˜•ì‹)
        function setTodayDate() {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            elements.date.value = dateString;
        }

        // ë‚ ì§œë¥¼ í•œêµ­ì–´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (YYYYë…„ MMì›” DDì¼)
        function formatDateToKorean(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${date.getFullYear()}ë…„ ${String(date.getMonth() + 1).padStart(2, '0')}ì›” ${String(date.getDate()).padStart(2, '0')}ì¼`;
        }

        // ê³ ê°ëª…ì„ "XXX ê³ ê°ë‹˜" í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function formatClientName(name) {
            if (!name.trim()) return '';
            return `${name.trim()} ê³ ê°ë‹˜`;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // í’ˆëª© ì¶”ê°€ ë²„íŠ¼
            elements.addItemBtn.addEventListener('click', addItem);
            elements.addItemBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                addItem();
            });

            // Enter í‚¤ ì´ë²¤íŠ¸
            const itemInputs = [
                elements.itemCategory, elements.itemName, elements.itemSpec,
                elements.itemQuantity, elements.itemUnit, elements.itemPrice
            ];

            itemInputs.forEach(input => {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.keyCode === 13) {
                        e.preventDefault();
                        addItem();
                    }
                });
                input.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter' || e.keyCode === 13) {
                        e.preventDefault();
                        addItem();
                    }
                });
            });

            // ê¸°íƒ€ ë²„íŠ¼ ì´ë²¤íŠ¸
            elements.previewBtn.addEventListener('click', previewQuote);
            elements.printBtn.addEventListener('click', printQuote);
            elements.downloadBtn.addEventListener('click', downloadPDF);
            elements.clearBtn.addEventListener('click', clearAll);

            // ë¯¸ë¦¬ë³´ê¸° ì°½ ë‹«ê¸°
            elements.closeBtn.addEventListener('click', closePreview);
            elements.previewOverlay.addEventListener('click', closePreview);
        }

        // í’ˆëª© ì¶”ê°€ í•¨ìˆ˜ (í•„ìˆ˜ í•­ëª© ê²€ì¦ ì¶”ê°€)
        function addItem() {
            const category = elements.itemCategory.value.trim();
            const name = elements.itemName.value.trim();
            const spec = elements.itemSpec.value.trim();
            const quantity = parseInt(elements.itemQuantity.value) || 0;
            const unit = elements.itemUnit.value.trim();
            const price = parseInt(elements.itemPrice.value) || 0;

            // í•„ìˆ˜ í•­ëª© ê²€ì¦
            if (!name) {
                alert('í’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (í•„ìˆ˜ í•­ëª©)');
                elements.itemName.focus();
                return;
            }

            if (quantity <= 0) {
                alert('ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (í•„ìˆ˜ í•­ëª©)');
                elements.itemQuantity.focus();
                return;
            }

            if (price <= 0) {
                alert('ë‹¨ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (í•„ìˆ˜ í•­ëª©)');
                elements.itemPrice.focus();
                return;
            }

            const total = quantity * price;
            const item = {
                id: itemIdCounter++,
                category: category,
                name: name,
                spec: spec,
                quantity: quantity,
                unit: unit,
                price: price,
                total: total
            };

            items.push(item);
            updateItemsTable();
            clearItemInputs();
            updateCalculations();
        }

        // í’ˆëª© í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateItemsTable() {
            elements.itemsTableBody.innerHTML = '';
            
            items.forEach(item => {
                const row = elements.itemsTableBody.insertRow();
                row.innerHTML = `
                    <td>${item.category}</td>
                    <td>${item.name}</td>
                    <td>${item.spec}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>${item.price.toLocaleString()}</td>
                    <td>${item.total.toLocaleString()}</td>
                    <td><button class="danger" onclick="deleteItem(${item.id})">ì‚­ì œ</button></td>
                `;
            });
        }

        // í’ˆëª© ì‚­ì œ
        function deleteItem(id) {
            if (confirm('ì´ í’ˆëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                items = items.filter(item => item.id !== id);
                updateItemsTable();
                updateCalculations();
            }
        }

        // í’ˆëª© ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        function clearItemInputs() {
            elements.itemCategory.value = '';
            elements.itemName.value = '';
            elements.itemSpec.value = '';
            elements.itemQuantity.value = '';
            elements.itemUnit.value = '';
            elements.itemPrice.value = '';
            elements.itemName.focus();
        }

        // ë¶€ê°€ì„¸ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
        function updateCalculations() {
            const subtotal = items.reduce((sum, item) => sum + item.total, 0);
            const vat = Math.round(subtotal * 0.1); // 10% ë¶€ê°€ì„¸
            const total = subtotal + vat;

            elements.subtotalAmount.textContent = `${subtotal.toLocaleString()}ì›`;
            elements.vatAmount.textContent = `${vat.toLocaleString()}ì›`;
            elements.totalAmount.textContent = `${total.toLocaleString()}ì›`;
        }

        // ì „ì²´ ì´ˆê¸°í™”
        function clearAll() {
            if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                items = [];
                elements.clientName.value = '';
                elements.clientPhone.value = '';
                elements.workDetails.value = '';
                elements.notes.value = '';
                setTodayDate();
                updateItemsTable();
                updateCalculations();
            }
        }

        // ê²¬ì ì„œ ë¯¸ë¦¬ë³´ê¸°
        function previewQuote() {
            if (items.length === 0) {
                alert('ë¯¸ë¦¬ë³´ê¸°í•  í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const content = generatePreviewContent();
            elements.previewContent.innerHTML = content;
            elements.previewOverlay.style.display = 'block';
            elements.previewWindow.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // ë¯¸ë¦¬ë³´ê¸° ì°½ ë‹«ê¸°
        function closePreview() {
            elements.previewOverlay.style.display = 'none';
            elements.previewWindow.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // ë¯¸ë¦¬ë³´ê¸° ë‚´ìš© ìƒì„± (í…Œì´ë¸” ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •)
        function generatePreviewContent() {
            const date = formatDateToKorean(elements.date.value);
            const clientName = formatClientName(elements.clientName.value);
            const clientPhone = elements.clientPhone.value;
            const workDetails = elements.workDetails.value;
            const notes = elements.notes.value;
            
            const subtotal = items.reduce((sum, item) => sum + item.total, 0);
            const vat = Math.round(subtotal * 0.1);
            const total = subtotal + vat;

            let content = `
                <div style="font-family: 'Malgun Gothic', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <div style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 40px; border-bottom: 3px solid #333; padding-bottom: 15px;">ê²¬ ì  ì„œ</div>
                    
                    <!-- í…Œì´ë¸” ê¸°ë°˜ ì •ë³´ ì„¹ì…˜ -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <tr>
                            <td style="width: 50%; padding-right: 20px; vertical-align: top;">
                                <div style="margin-bottom: 8px; font-size: 14px;"><span style="font-weight: bold; display: inline-block; width: 80px;">ì¼ì‹œ:</span> ${date}</div>
                                <div style="margin-bottom: 8px; font-size: 14px;"><span style="font-weight: bold; display: inline-block; width: 80px;">ë°›ëŠ”ë¶„:</span> ${clientName}</div>
                                <div style="margin-bottom: 8px; font-size: 14px;"><span style="font-weight: bold; display: inline-block; width: 80px;">ì „í™”:</span> ${clientPhone}</div>
                                <div style="margin-bottom: 8px; font-size: 14px;"><span style="font-weight: bold; display: inline-block; width: 80px;">ì‹œê³µë‚´ì—­:</span> ${workDetails}</div>
                            </td>
                            <td style="width: 50%; padding-left: 20px; text-align: right; vertical-align: top;">
                                <div style="margin-bottom: 8px; font-size: 14px;"><span style="font-weight: bold; display: inline-block; width: 80px;">ì‹œê³µì:</span> ì¢‹ì€ì´ì›ƒ ì¸í…Œë¦¬ì–´</div>
                                <div style="margin-bottom: 8px; font-size: 14px;"><span style="font-weight: bold; display: inline-block; width: 80px;">ì „í™”:</span> 010-6687-5111</div>
                                <div style="margin-bottom: 8px; font-size: 14px;"><span style="font-weight: bold; display: inline-block; width: 80px;">ì£¼ì†Œ:</span> ê²½ê¸°ë„ í™”ì„±ì‹œ í•œì‹ ëŒ€ê¸¸ 83</div>
                            </td>
                        </tr>
                    </table>
                    
                    <div style="font-size: 16px; font-weight: bold; margin: 30px 0 15px 0; padding: 8px 0; border-bottom: 2px solid #666;">ì„¸ë¶€ì‹œê³µë‚´ì—­</div>
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="background-color: #f0f0f0; border: 1px solid #333; padding: 10px 5px; text-align: center; font-weight: bold; width: 12%">í’ˆëª©</th>
                                <th style="background-color: #f0f0f0; border: 1px solid #333; padding: 10px 5px; text-align: center; font-weight: bold; width: 20%">í’ˆëª…</th>
                                <th style="background-color: #f0f0f0; border: 1px solid #333; padding: 10px 5px; text-align: center; font-weight: bold; width: 18%">ê·œê²©</th>
                                <th style="background-color: #f0f0f0; border: 1px solid #333; padding: 10px 5px; text-align: center; font-weight: bold; width: 8%">ìˆ˜ëŸ‰</th>
                                <th style="background-color: #f0f0f0; border: 1px solid #333; padding: 10px 5px; text-align: center; font-weight: bold; width: 8%">ë‹¨ìœ„</th>
                                <th style="background-color: #f0f0f0; border: 1px solid #333; padding: 10px 5px; text-align: center; font-weight: bold; width: 15%">ë‹¨ê°€</th>
                                <th style="background-color: #f0f0f0; border: 1px solid #333; padding: 10px 5px; text-align: center; font-weight: bold; width: 19%">ê³µê¸‰ê°€ì•¡</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            items.forEach(item => {
                content += `
                    <tr>
                        <td style="border: 1px solid #333; padding: 8px 5px; text-align: left;">${item.category}</td>
                        <td style="border: 1px solid #333; padding: 8px 5px; text-align: left;">${item.name}</td>
                        <td style="border: 1px solid #333; padding: 8px 5px; text-align: left;">${item.spec}</td>
                        <td style="border: 1px solid #333; padding: 8px 5px; text-align: center;">${item.quantity}</td>
                        <td style="border: 1px solid #333; padding: 8px 5px; text-align: center;">${item.unit}</td>
                        <td style="border: 1px solid #333; padding: 8px 5px; text-align: right;">${item.price.toLocaleString()}</td>
                        <td style="border: 1px solid #333; padding: 8px 5px; text-align: right;">${item.total.toLocaleString()}</td>
                    </tr>
                `;
            });

            content += `
                        </tbody>
                    </table>
                    
                    <!-- ë¶€ê°€ì„¸ ê³„ì‚° í…Œì´ë¸” -->
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px;">
                        <tr>
                            <td style="border: 1px solid #333; padding: 8px 5px; text-align: center; font-weight: bold; background-color: #f0f0f0; width: 70%;">ì†Œê³„</td>
                            <td style="border: 1px solid #333; padding: 8px 5px; text-align: right; width: 30%;">${subtotal.toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #333; padding: 8px 5px; text-align: center; font-weight: bold; background-color: #f0f0f0;">ë¶€ê°€ì„¸ / VAT (10%)</td>
                            <td style="border: 1px solid #333; padding: 8px 5px; text-align: right;">${vat.toLocaleString()}</td>
                        </tr>
                        <tr style="background-color: #f8f8f8; font-weight: bold;">
                            <td style="border: 1px solid #333; padding: 8px 5px; text-align: center; font-weight: bold; background-color: #f0f0f0;"><strong>í•©ê³„ (ë¶€ê°€ì„¸ í¬í•¨)</strong></td>
                            <td style="border: 1px solid #333; padding: 8px 5px; text-align: right;"><strong>${total.toLocaleString()}</strong></td>
                        </tr>
                    </table>
                    
                    <div style="margin-top: 20px; font-size: 14px;">
                        <strong>*ê³„ì•½ê¸ˆ ë³„ë„</strong>
                    </div>
            `;

            if (notes.trim()) {
                content += `
                    <div style="margin-top: 30px; padding: 15px; background-color: #f9f9f9; border-left: 4px solid #007bff;">
                        <div style="font-weight: bold; margin-bottom: 10px;">ê¸°íƒ€ì‚¬í•­</div>
                        <div style="font-size: 13px; line-height: 1.5; white-space: pre-line;">${notes}</div>
                    </div>
                `;
            }

            content += `
                    <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #666;">
                        ê²¬ì ì„œ ë°œí–‰ì¼: ${new Date().toLocaleDateString('ko-KR')}
                    </div>
                </div>
            `;

            return content;
        }

        // PDFìš© ë°ì´í„° ì—…ë°ì´íŠ¸
        function updatePDFContent() {
            const date = formatDateToKorean(elements.date.value);
            const clientName = formatClientName(elements.clientName.value);
            const clientPhone = elements.clientPhone.value;
            const workDetails = elements.workDetails.value;
            const notes = elements.notes.value;
            
            const subtotal = items.reduce((sum, item) => sum + item.total, 0);
            const vat = Math.round(subtotal * 0.1);
            const total = subtotal + vat;

            // PDF ì½˜í…ì¸  ì—…ë°ì´íŠ¸
            document.getElementById('pdfDate').textContent = date;
            document.getElementById('pdfClientName').textContent = clientName;
            document.getElementById('pdfClientPhone').textContent = clientPhone;
            document.getElementById('pdfWorkDetails').textContent = workDetails;
            document.getElementById('pdfSubtotal').textContent = subtotal.toLocaleString();
            document.getElementById('pdfVat').textContent = vat.toLocaleString();
            document.getElementById('pdfTotal').textContent = total.toLocaleString();
            document.getElementById('pdfIssueDate').textContent = new Date().toLocaleDateString('ko-KR');

            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            const pdfTableBody = document.getElementById('pdfTableBody');
            pdfTableBody.innerHTML = '';
            
            items.forEach(item => {
                const row = pdfTableBody.insertRow();
                row.innerHTML = `
                    <td class="text-left">${item.category}</td>
                    <td class="text-left">${item.name}</td>
                    <td class="text-left">${item.spec}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td class="text-right">${item.price.toLocaleString()}</td>
                    <td class="text-right">${item.total.toLocaleString()}</td>
                `;
            });

            // ê¸°íƒ€ì‚¬í•­ ì—…ë°ì´íŠ¸
            const pdfNotesSection = document.getElementById('pdfNotesSection');
            const pdfNotes = document.getElementById('pdfNotes');
            
            if (notes.trim()) {
                pdfNotes.textContent = notes;
                pdfNotesSection.style.display = 'block';
            } else {
                pdfNotesSection.style.display = 'none';
            }
        }

        // html2pdf.jsë¥¼ ì‚¬ìš©í•œ PDF ë‹¤ìš´ë¡œë“œ
        function downloadPDF() {
            if (items.length === 0) {
                alert('ì €ì¥í•  í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
            elements.loadingSpinner.style.display = 'block';
            
            // PDF ì½˜í…ì¸  ì—…ë°ì´íŠ¸
            updatePDFContent();
            
            // PDF ì½˜í…ì¸  í‘œì‹œ
            elements.pdfContent.style.display = 'block';

            // html2pdf ì˜µì…˜ ì„¤ì •
            const clientNameForFile = elements.clientName.value || 'ê³ ê°';
            const dateForFile = formatDateToKorean(elements.date.value).replace(/[ë…„ì›”ì¼]/g, '').replace(/\s/g, '');
            
            const options = {
                margin: [10, 10, 10, 10],
                filename: `ê²¬ì ì„œ_${clientNameForFile}_${dateForFile}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    letterRendering: true,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait' 
                }
            };

            // html2pdf ì‹¤í–‰
            html2pdf()
                .set(options)
                .from(elements.pdfContent)
                .save()
                .then(() => {
                    // ì„±ê³µ ì‹œ ì²˜ë¦¬
                    elements.loadingSpinner.style.display = 'none';
                    elements.pdfContent.style.display = 'none';
                })
                .catch((error) => {
                    // ì—ëŸ¬ ì‹œ ì²˜ë¦¬
                    console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
                    elements.loadingSpinner.style.display = 'none';
                    elements.pdfContent.style.display = 'none';
                    alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                });
        }

        // ì¸ì‡„í•˜ê¸°
        function printQuote() {
            if (items.length === 0) {
                alert('ì¸ì‡„í•  í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const content = generatePreviewContent();
            const printWindow = window.open('', '_blank');
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ê²¬ì ì„œ</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        @page { margin: 0.5in; size: A4; }
                        body { font-family: 'Malgun Gothic', Arial, sans-serif; margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact; }
                        @media (max-width: 768px) { 
                            table td { width: 100% !important; padding: 0 !important; text-align: left !important; }
                        }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `;
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                printWindow.print();
                printWindow.onafterprint = function() { 
                    printWindow.close(); 
                };
            };
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
